# M412 should turn the runout sensor on or off in Marlin
# So try and convice Klipper to do the same
# mh 2021.08.03 
[gcode_macro M412]
variable_sensor=0
variable_enable=0
variable_e='"extruder"'
variable_other1='1'
variable_other2='2'
variable_enable_text="Enabled"
gcode: 

# Get the enable state (S0 or S1)
    {% set enable = params.S %} 
    {% set e = printer.save_variables.variables.currentextruder %}

    M118 Processing gcode M412 S{enable}

# Default to Runout0 for extruder0 ("extruder") if extruder1 or extruder2 are not found
    {% if e == "extruder1" %}
    {% set sensor = '1' %}
    {% set other1 = '0' %}
    {% set other2 = '2' %}
    {% endif %}

    {% if e == "extruder2" %}
    {% set sensor = '2' %}
    {% set other1 = '0' %}
    {% set other2 = '1' %}
    {% endif %}

    {% if enable == "0" %}
    {% set enable_text = "Disabled" %}
    {% endif %}

#   Turn the unused runout sensors off in order to avoid any spurious runout indications
#    M118 SET_FILAMENT_SENSOR SENSOR=Runout{other1} ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=Runout{other1} ENABLE=0
#    M118 SET_FILAMENT_SENSOR SENSOR=Runout{other2} ENABLE=0
#    SET_FILAMENT_SENSOR SENSOR=Runout{other2} ENABLE=0

#   Turn the runout sensor for the active extruder to the desired state
    M118 Runout{sensor} state set to {enable_text} ({enable}) for extruder '{e}'
#    M118 SET_FILAMENT_SENSOR SENSOR=Runout{sensor} ENABLE={enable}
    SET_FILAMENT_SENSOR SENSOR=Runout{sensor} ENABLE={enable}
