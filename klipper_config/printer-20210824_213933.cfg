[include kiauh_macros.cfg]
# This file contains common pin mappings for the Geeetech GT2560
# board. GT2560 board uses a firmware compiled for the AVR
# atmega2560.

# See docs/Config_Reference.md for a description of parameters.

#mh 2021.07.07 changes for v4.1B controller in Geeetech A10x printers and likely A20x
#mh 2021.07.08 added G29 macro for bed mesh
#mh 2021.07.10 added M412, M900, T0 and T1 macros to do nothing
#mh 2021.07.10 added input shaper values
#mh 2021.07.18 added bed screws config and moved bed sensor to the side inline with the nozzle
#mh 2021.07.19 configure the smart runout sensors
#mh 2021.07.19 configure adxl345 & re-tune the x and y values

[stepper_x]
step_pin: PC0
dir_pin: !PG2
enable_pin: !PC2
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PA2
#mh position_endstop: 0
#mh x home switch adjusted for purge bucket
position_endstop: -10
#position_max: 220
position_max: 228
position_min: -10
homing_speed: 30


[stepper_y]
step_pin: PC6
dir_pin: !PC4
enable_pin: !PA7
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PA6
position_endstop: 0
position_min: -8
#position_max: 220
position_max: 235
homing_speed: 30


[stepper_z]
step_pin: PA3
dir_pin: PA1
enable_pin: !PA5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
#mh design max is 260 but blocked by frame and extruder mounting
position_max: 250
#position_min: 0.0
position_min: -5

#mh bed probe can be either [bltouch] or [probe] uncomment one and comment out the other 
#
#mh uncomment the [bltouch] sensor_pin and control pin lines to use a bltouch or 3dtouch
[bltouch]
sensor_pin: ^PC7
control_pin: PB5
#
#mh uncomment the [probe] and pin lines to use proximity sensor 
#[probe]
#pin: ^!PC7
#
#mh set the x and y offset of the probe with respect to the nozzle
x_offset: -50.0
y_offset: 0.0
#
#mh customize the z_offset to match your nozzle height to bed distance at the point where the probe triggers
#z_offset: 0.55
speed: 5.0
samples: 2
sample_retract_dist: 5.0
lift_speed: 5.0
samples_result: average
samples_tolerance: 0.100
samples_tolerance_retries: 1

[extruder]
# extruder confgig info https://github.com/KevinOConnor/klipper/blob/master/docs/Rotation_Distance.md
# rotation_distance = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>
# rotation_distance = ((360 / 1.8) * 16 ) / 438 = 7.305936
# rotation_distance = ((360 / 1.8) * 16 ) / 400 = 8
#mh Extruder E0 (A10, A10M, A10T)
step_pin: PL3
dir_pin: PL5
enable_pin: !PB6
microsteps: 16
#rotation_distance: 8
rotation_distance: 7.9
nozzle_diameter: 0.4
filament_diameter: 1.750
heater_pin: PB4
sensor_type: ATC Semitec 104GT-2
sensor_pin: PK3
#mh min temp set to -100 so that it works sans temp sensor for disconnected testing
min_temp: -100
#mh max temp set to max 250+15 so that overshoots from setting to 250 don't cause overtemp shutdown
max_temp: 265
control: pid
#mh these values are for a BTT 2in1out switching extruder
pid_kp: 11.68
pid_ki: 0.68
pid_kd: 50.01
#mh increased these value to avoid errors with long extract-advance valueswhen switching filaments
max_extrude_cross_section: 50.0
max_extrude_only_distance: 100
#mh run tuning test to determine the value for your machine
#mh https://github.com/KevinOConnor/klipper/blob/master/docs/Pressure_Advance.md#tuning-pressure-advance
#
# measured with D3D Sigma green PLA on E0
#pressure_advance: 0.48
#
# measured with D3D Sigma prototying ASA
#pressure_advance: 0.54
#

[extruder1]
#mh Extruder E1 (A10M, A10T)
step_pin: PL0
dir_pin: PL2
enable_pin: !PL1
microsteps: 16
rotation_distance: 8
nozzle_diameter: 0.4
filament_diameter: 1.750
shared_heater: extruder
max_extrude_cross_section: 50.0
max_extrude_only_distance: 100
#measured with D3D Sigma green PLA on E0
#pressure_advance: 0.48

#[extruder2]
##mh Extruder E2 (A10T)
#step_pin: PL6
#dir_pin: !PL4
#enable_pin: !PG0
#microsteps: 16
##rotation_distance: 33.500
#rotation_distance: 7.305936
#nozzle_diameter: 0.4
#filament_diameter: 1.750
#shared_heater: extruder
#max_extrude_cross_section: 50.0
#max_extrude_only_distance: 100

[heater_bed]
heater_pin: PG5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PK2
min_temp: -100
max_temp: 120
control: pid
pid_kp: 182.46
pid_ki: 35.92
pid_kd: 231.70

[fan]
#mh PWM8_FAN0 is FAN_E0 on PH6
pin: PH6

[mcu]
# to find the serial port plug in the usb to the printer and in Linux do  # ls /dev/serial/by-id
# note that the by-id will only show if there is something plugged in for it to show
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

[printer]
kinematics: cartesian
max_z_velocity: 5
max_velocity: 500
#max_accel: 500
#max_accel: 2000
# adxl345 analysis suggested X max_accel <= 13600 mm/sec^2
# adxl345 analysis suggested y max_accel <= 5800 mm/sec^2
#max_accel: 5000
# 5000 seems to cause horizontal layer shifts on Y
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[respond]
default_type: echo
default_prefix: echo:

[gcode_arcs]
resolution: 1.0

[safe_z_home]
home_xy_position: 125,125
speed: 100.0
z_hop: 10
z_hop_speed: 5
move_to_previous: False

[bed_mesh]
speed: 100
#horizontal_move_z: 5
#mh x,y set to place the first probe point on the front left corner of the bed
mesh_min: 5,10
#mh x=(bed x max minus probe x offset),y=(print area max)
mesh_max: 178,225
probe_count: 5,5
fade_start: 1.0
fade_end: 10.0
#fade_target:
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2

[bed_screws]
screw1: 35,35
screw2: 185,35
screw3: 185,175
screw4: 35,175

[screws_tilt_adjust]
horizontal_move_z: 5
screw1: 85,35
screw1_name: front left
screw2: 225,35
screw2_name: front right
screw3: 225,175
screw3_name: back right
screw4: 85,175
screw4_name: back left

[input_shaper]
#mh follow steps here to configure for your printer :
#mh https://github.com/KevinOConnor/klipper/blob/master/docs/Resonance_Compensation.md
#shaper_freq_x: 42.164
#shaper_freq_y: 44.727
#mh adxl345 values
#shaper_freq_x: 70  
shaper_freq_x: 81
shaper_type_x: mzv
#shaper_freq_y: 56.0 
shaper_freq_y: 54.6 
shaper_type_y: ei

[save_variables]
filename: ~/klipper_config/variables.cfg

#mh A10x 4x20 display config
[include display.cfg]

#mh fluidd-provided macros
[include fluidd.cfg]

#mh there is no G29, invoke a bed mesh with a macro
[include G29.cfg]

#mh M412 (Filament runout enable/disable) implementation via macro
[include M412.cfg]

#mh M900 (linear advance) emitted by Cura but not implemented in Klipper, noop it with a macro to hide the error
[include M900.cfg]

#mh T0, T1, T2 implemented via macros
[include Tx.cfg]

#mh M211 not implemented, noop with a macro
[include M211.cfg]

#mh M81 power off printer gcode macro
[include M81.cfg]

#mh G10, G11 firmware retraction support
[include retraction.cfg]

#mh filament runout sensor definition and handling
[include runout.cfg]

#mh some additional general macros
[include macros.cfg]

#mh ADXL45 resonance test board - uncomment when needing to run tests
#[include ADXL345.cfg]

#mh try and activate the LCD ? - nope, not working 
#[include menu.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 2.260
